<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Itim&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Mitr:wght@200;300;400;500;600;700&family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Sarabun:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap"
    rel="stylesheet">
  <title>Soundboard Offline ‚Äî Mobile Friendly</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#111827; --border:#223047; --text:#e5e7eb; --muted:#94a3b8;
      --btn:#0ea5e9; --btn2:#22c55e; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a 40%,#0b1220);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:clamp(18px,4vw,26px);margin:0 0 10px;font-weight:800}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
    .group{display:flex;gap:8px;align-items:center;background:rgba(17,24,39,.7);border:1px solid rgba(148,163,184,.16);padding:10px;border-radius:14px}
    .btn{appearance:none;border:none;background:linear-gradient(180deg,#1f2937,#111827);color:var(--text);padding:10px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.25);cursor:pointer;transition:.15s;box-shadow:inset 0 1px 0 rgba(255,255,255,.05)}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7);border-color:#38bdf8}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#86efac}
    .btn.ghost{background:transparent}
    .btn.danger{background:linear-gradient(180deg,#b91c1c,#7f1d1d);border-color:#ef4444}

    input[type="file"]{display:none}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px}
    @media (max-width:480px){ .grid{grid-template-columns:repeat(2,1fr);} }

    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(148,163,184,.16);border-radius:18px;padding:12px;display:flex;flex-direction:column;gap:10px;min-height:150px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .name{width:100%;background:transparent;border:1px dashed rgba(148,163,184,.25);border-radius:10px;padding:8px;color:var(--text)}
    .pad{display:block;width:100%;text-align:center;font-weight:800;border-radius:14px;padding:12px;border:1px solid rgba(148,163,184,.25);cursor:pointer}
    .tag{font-size:12px;opacity:.8}
    .hint{margin-top:10px;font-size:12px;opacity:.75}
  </style>
</head>
<body>
  <div class="container">
    <h1>üéõÔ∏è Soundboard ‡∏Å‡∏≤‡∏£‡πÄ‡πÄ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡πå</h1>

    <div class="toolbar">
      <div class="group">
        <label class="btn primary" for="fileInput">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</label>
        <input id="fileInput" type="file" accept="audio/*" multiple />
        <button id="addUrlBtn" class="btn">üîó ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå URL</button>
        <button id="stopAllBtn" class="btn ghost">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
      <div class="group">
        <button id="exportBtn" class="btn">‚¨áÔ∏è ‡∏™‡∏≥‡∏£‡∏≠‡∏á (JSON)</button>
        <label class="btn" for="importInput">‚¨ÜÔ∏è ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</label>
        <input id="importInput" type="file" accept="application/json" />
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div class="hint">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å URL ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï CORS) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡πá‡∏ï‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
  </div>

<script>
(function(){
  const DB='sb-offline-v2'; const STORE='sounds';
  let db; // IndexedDB handle
  const state={ items:[], playing:new Map() };

  // ---------- IndexedDB helpers ----------
  const openDB=()=>new Promise((res,rej)=>{ const r=indexedDB.open(DB,1); r.onupgradeneeded=()=>{const d=r.result; if(!d.objectStoreNames.contains(STORE)){ const s=d.createObjectStore(STORE,{keyPath:'id',autoIncrement:true}); s.createIndex('name','name',{unique:false}); }}; r.onsuccess=()=>{db=r.result; res(db)}; r.onerror=()=>rej(r.error)});
  const store=(mode='readonly')=>db.transaction(STORE,mode).objectStore(STORE);
  const getAll=()=>new Promise((res,rej)=>{ const r=store().getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
  const add=rec=>new Promise((res,rej)=>{ const r=store('readwrite').add(rec); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
  const put=rec=>new Promise((res,rej)=>{ const r=store('readwrite').put(rec); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
  const del=id=>new Promise((res,rej)=>{ const r=store('readwrite').delete(id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });

  // ---------- Utils ----------
  const el=s=>document.querySelector(s);
  const grid=el('#grid');
  const colorDefault=(i)=>['#0ea5e9','#22c55e','#f59e0b','#a78bfa','#ef4444','#14b8a6','#f472b6','#60a5fa'][i%8];
  const blobToDataURL=(blob)=>new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=()=>rej(fr.error); fr.readAsDataURL(blob); });
  const dataURLToBlob=async(dataURL)=>{ const [meta,b64]=dataURL.split(','); const mime=meta.match(/data:(.*);base64/)[1]; const bin=atob(b64); const bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); return new Blob([bytes],{type:mime}); };

  // ---------- Audio control ----------
  const createAudio=(rec)=>{ const src=URL.createObjectURL(rec.blob); const a=new Audio(src); a.loop=!!rec.loop; a.onended=()=>{ if(!a.loop) state.playing.delete(rec.id); }; return a; };
  const playToggle=async(id)=>{ const rec=state.items.find(x=>x.id===id); if(!rec) return; const cur=state.playing.get(id); if(cur){ cur.pause(); cur.currentTime=0; state.playing.delete(id); return; } const a=createAudio(rec); state.playing.set(id,a); try{ await a.play(); }catch(e){ alert('‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message); state.playing.delete(id); }};
  const stopAll=()=>{ for(const a of state.playing.values()) a.pause(); state.playing.clear(); };

  // ---------- Render ----------
  const render=()=>{
    grid.innerHTML='';
    state.items.forEach((rec,idx)=>{
      const card=document.createElement('div'); card.className='card';

      const nameRow=document.createElement('div'); nameRow.className='row';
      const nameInput=document.createElement('input'); nameInput.className='name'; nameInput.value=rec.name||'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'; nameInput.placeholder='‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
      nameInput.addEventListener('change',async()=>{ rec.name=nameInput.value; await put(rec); });

      const pad=document.createElement('button'); pad.className='pad'; pad.style.background=`linear-gradient(180deg, ${rec.color||colorDefault(idx)}, rgba(0,0,0,.25))`; pad.textContent= state.playing.has(rec.id) ? '‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î' : '‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô';
      pad.addEventListener('click', async()=>{ await playToggle(rec.id); pad.textContent= state.playing.has(rec.id) ? '‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î' : '‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô'; });

      const row=document.createElement('div'); row.className='row';
      const loopLbl=document.createElement('label');
      const loopChk=document.createElement('input'); loopChk.type='checkbox'; loopChk.checked=!!rec.loop; loopChk.addEventListener('change',async()=>{ rec.loop=loopChk.checked; await put(rec); const a=state.playing.get(rec.id); if(a) a.loop=rec.loop; });
      loopLbl.append('üîÅ ‡∏•‡∏π‡∏õ ', loopChk);

      const color=document.createElement('input'); color.type='color'; color.value= rec.color || colorDefault(idx);
      color.addEventListener('input',async()=>{ rec.color=color.value; await put(rec); render(); });

      const delBtn=document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='üóëÔ∏è ‡∏•‡∏ö'; delBtn.addEventListener('click', async()=>{ if(confirm('‡∏•‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){ await del(rec.id); stopOne(rec.id); await load(); }});

      row.append(loopLbl, color, delBtn);

      const tag=document.createElement('div'); tag.className='tag'; tag.textContent= rec.source ? `‡∏ó‡∏µ‡πà‡∏°‡∏≤: ${rec.source}` : '‡∏ó‡∏µ‡πà‡∏°‡∏≤: ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á';

      card.append(nameRow, pad, row, tag);
      nameRow.append(nameInput);
      grid.appendChild(card);
    });
  };
  const stopOne=(id)=>{ const a=state.playing.get(id); if(a){ a.pause(); state.playing.delete(id);} };

  // ---------- Import / Export ----------
  const exportAll=async()=>{
    const items=await getAll();
    const enriched=await Promise.all(items.map(async r=>({
      id:r.id,name:r.name,loop:!!r.loop,color:r.color||'',source:r.source||'',
      dataURL: await blobToDataURL(r.blob)
    })));
    const payload={version:2, exportedAt:new Date().toISOString(), items:enriched};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='soundboard-backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500);
  };

  const importAll=async(file)=>{
    try{ const text=await file.text(); const data=JSON.parse(text); if(!data.items) throw new Error('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      for(const it of data.items){ const blob= await dataURLToBlob(it.dataURL); await add({ name:it.name||'‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', loop:!!it.loop, color:it.color||'', source:it.source||'', blob }); }
      await load(); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }catch(e){ alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
  };

  // ---------- Load & UI events ----------
  const load=async()=>{ await openDB(); state.items=await getAll(); render(); };

  document.getElementById('fileInput').addEventListener('change', async(e)=>{
    const files=Array.from(e.target.files||[]); if(!files.length) return;
    for(const f of files){ const blob=f; await add({ name:f.name.replace(/\.[^/.]+$/, ''), loop:false, color:'', source:'‡πÑ‡∏ü‡∏•‡πå‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô', blob }); }
    e.target.value=''; await load();
  });

  document.getElementById('addUrlBtn').addEventListener('click', async()=>{
    const url=prompt('‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (.mp3/.wav)'); if(!url) return;
    const name=prompt('‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á','‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå');
    try{ const res=await fetch(url,{mode:'cors'}); const blob=await res.blob(); await add({ name:name||'‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå', loop:false, color:'', source:url, blob }); await load(); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }
    catch(e){ alert('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å URL ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î CORS)'); }
  });

  document.getElementById('stopAllBtn').addEventListener('click', stopAll);
  document.getElementById('exportBtn').addEventListener('click', exportAll);
  document.getElementById('importInput').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) importAll(f); e.target.value=''; });

  load();
})();
</script>
</body>
</html>
